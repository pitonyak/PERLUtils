<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Pitonyak::XMLUtil - Convert Objects to and from XML.</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<body style="background-color: white">


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<ul>

		<li><a href="#convert_entity_references_to_characters">convert_entity_references_to_characters</a></li>
		<li><a href="#convert_xml_characters_to_entity_references">convert_xml_characters_to_entity_references</a></li>
		<li><a href="#object_to_xml">object_to_xml</a></li>
		<li><a href="#xml_to_object">xml_to_object</a></li>
	</ul>

	<li><a href="#copyright">COPYRIGHT</a></li>
	<li><a href="#modification_history">Modification History</a></li>
	<ul>

		<li><a href="#september_10__2002">September 10, 2002</a></li>
		<li><a href="#july_13__2009">July 13, 2009</a></li>
	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->

<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Pitonyak::XMLUtil - Convert Objects to and from XML.</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>A few simple XML utilities that will convert arbitrary objects to XML and back again.
These routines have not been extensively tested.</p>
<p>
</p>
<h2><a name="convert_entity_references_to_characters">convert_entity_references_to_characters</a></h2>
<dl>
<dt><strong><a name="convert_entity_references_to_characters" class="item"><code>convert_entity_references_to_characters(@strings_with_entity_refs)</code></a></strong></dt>

</dl>
<p>Change '&amp;amp;' to '&amp;', '&amp;lt;' to '&lt;', '&amp;gt;' to '&gt;', '&amp;quot;' to '&quot;', and '&amp;apos;' to &quot;'&quot;.</p>
<p>The calling parameters are modfied</p>
<p>
</p>
<h2><a name="convert_xml_characters_to_entity_references">convert_xml_characters_to_entity_references</a></h2>
<dl>
<dt><strong><a name="convert_xml_characters_to_entity_references" class="item"><code>convert_xml_characters_to_entity_references(@strings_needing_entity_refs)</code></a></strong></dt>

</dl>
<p>Change '&amp;' to '&amp;amp;', '&lt;' to '&amp;lt;', '&gt;' to '&amp;gt;', '&quot;' to '&amp;quot;', and &quot;'&quot; to '&amp;apos;',</p>
<p>The calling parameters are modfied.</p>
<p>This is used to render a string safe to send as XML.
Existing entity referenes will have their leading ampersand transformed.</p>
<p>
</p>
<h2><a name="object_to_xml">object_to_xml</a></h2>
<dl>
<dt><strong><a name="object_to_xml" class="item"><code>object_to_xml(@objects_to_transform)</code></a></strong></dt>

</dl>
<p>Transform an object into XML.
An attempt is made to make this object human readable.
Note that if the object is a package object that is referenced as a HASH
it is still embedded as a HASH.</p>
<p>Each object in the array is returned as a separate XML string.</p>
<pre>

An object that is not defined is returned as C&lt;E&lt;lt&gt;NULLE&lt;sol&gt;E&lt;gt&gt;&gt;&gt;</pre>
<p>A SCALAR is rendered XML safe by converting special characters to entity references.
It is otherwise left unchanged.</p>
<p>A Reference to a SCALAR is encoded as <code>&lt;REF/&gt;</code> for a zero length SCALAR and as
<code>&lt;REF&gt;value&lt;/REF&gt;</code></p>
<p>An ARRAY reference is encoded as either <code>&lt;ARRAY/&gt;</code> or something similar to
<code>&lt;ARRAY&gt;&lt;VALUE&gt;value&lt;/VALUE&gt;&lt;/ARRAY&gt;</code>.</p>
<p>A HASH reference is encoded as
<code>&lt;HASH&gt;&lt;PAIR&gt;&lt;KEY&gt;value&lt;/KEY&gt;&lt;VALUE&gt;value&lt;VALUE&gt;&lt;/PAIR&gt;&lt;/HASH&gt;</code>
A PAIR may be missing a <code>VALUE</code> which means that it is undefined.</p>
<p>If a value is really the intended value, then it is rendered XML safe by using entity references
and no extra space is used. If the value is a reference to something else then the object is converted
to XML using extra white space and indentation for easier reading.</p>
<pre>

=cut</pre>
<p>#************************************************************</p>
<p>sub object_to_xml
{
  return undef if $#_ &lt; 0;
  my @object_xmls = ();
  foreach my $thing_to_print (@_)
  {
    my $txt = internal_object_to_xml( '', $thing_to_print );
    push @object_xmls, $txt if <code>defined($txt)</code> &amp;&amp; <code>length($txt)</code> &gt; 0;
  }
  return wantarray ? @object_xmls : $object_xmls[0];
}</p>
<p>#*********************************************************************
#**                                                                 **
#**  Input : Array reference of an XML object                       **
#**          Index into the array from which to start               **
#**                                                                 **
#**  Output: XML converted back to objects                          **
#**                                                                 **
#**  Notes : This takes the string from object_to_xml               **
#**                                                                 **
#*********************************************************************</p>
<p>sub internal_xml_to_object
{
  return undef if $#_ &lt; 0;
  if ( ref( $_[0] ) ne 'ARRAY' )
  {
    carp( &quot;Array reference expected as the first parameter, not&quot;
        . ref( $_[0] ) );
    return undef;
  }
  my $array_ref = shift;
  my $tag_start = 0;
  $tag_start = shift unless $#_ &lt; 0;
  if ( $tag_start &gt; $#$array_ref )
  {
    confess(
    &quot;Requested an index of $tag_start when the array is not large enough&quot;
    );
    return undef;
  }
  my $obj;
  my $element_name = $array_ref-&gt;[$tag_start];
  my $element;
  $element = $array_ref-&gt;[ $tag_start + 1 ] if $tag_start &lt; $#$array_ref;
  if ( $element_name eq '0' )
  {
    if ( <code>defined($element)</code> )
    {
      $obj = <a href="#convert_entity_references_to_characters"><code>convert_entity_references_to_characters($element)</code></a>;
    }
    else
    {
      $obj = '';
    }
  }
  elsif ( $element_name eq 'NULL' )
  {
    # $obj is already undefined
  }
  elsif ( <code>defined($element)</code> &amp;&amp; <code>ref($element)</code> ne 'ARRAY' )
  {
    carp( &quot;The element $element_name is not followed by an array, it is an &quot;
          . <code>ref($element)</code> );
  }
  elsif ( $element_name eq 'REF' )
  {
    my $temp = internal_xml_to_object( $element, 1 );
    $obj = \$temp;
  }
  elsif ( $element_name eq 'ARRAY' )
  {
    my @my_array  = ();
    my $array_len = 0;
    if ( <code>defined($element)</code> )
    {
      $array_len = $#$element;
    }
    for ( my $i = 1 ; $i &lt; $array_len ; $i += 2 )
    {
      if ( $element-&gt;[$i] eq 'Value' )
      {
        my $val_array           = $element-&gt;[ $i + 1 ];
        my $length_of_val_array = $#$val_array;
        if ( $length_of_val_array == 0 )
        {
          push @my_array ,'';
        }
        else
        {
          my $idx_to_use = 1;
          for (my $k = 1 ;$k &lt; $length_of_val_array ;$k += 2)
          {
            $idx_to_use = $k if $val_array-&gt;[$k] ne '0';
          }
          push @my_array, internal_xml_to_object( $val_array, $idx_to_use );
        }
      }
    }
    $obj = \@my_array;
  }
  elsif ( $element_name eq 'HASH' )
  {
    my %my_hash   = ();
    my $array_len = 0;
    if ( <code>defined($element)</code> )
    {
      $array_len = $#$element;
    }
    for ( my $i = 1 ; $i &lt; $array_len ; $i += 2 )
    {
      # skip white space
      if ( $element-&gt;[$i] eq 'Pair' )
      {
        my ( $key, $val );
        my $internal_array     = $element-&gt;[ $i + 1 ];
        my $internal_array_len = $#$internal_array;
        for ( my $j = 1 ; $j &lt; $internal_array_len ; $j += 2 )
        {
          if ( $internal_array-&gt;[$j] eq 'Key' )
          {
            my $key_array           = $internal_array-&gt;[ $j + 1 ];
            my $length_of_key_array = $#$key_array;
            if ( $length_of_key_array == 0 )
            {
              $key = '';
            }
            else
            {
              my $idx_to_use = 1;
              for (my $k = 1 ;$k &lt; $length_of_key_array ; $k += 2)
              {
                $idx_to_use = $k if $key_array-&gt;[$k] ne '0';
              }
              $key = internal_xml_to_object( $key_array, $idx_to_use );
            }
          }
          elsif ( $internal_array-&gt;[$j] eq 'Value' )
          {
            my $val_array           = $internal_array-&gt;[ $j + 1 ];
            my $length_of_val_array = $#$val_array;
            if ( $length_of_val_array == 0 )
            {
              $val = '';
            }
            else {
              my $idx_to_use = 1;
              for (my $k = 1 ;$k &lt; $length_of_val_array ;$k += 2)
              {
                $idx_to_use = $k if $val_array-&gt;[$k] ne '0';
              }
              $val = internal_xml_to_object( $val_array, $idx_to_use );
            }
          }
        }
        $my_hash{$key} = $val;
      }
    }
    $obj = \%my_hash;
  }
  return $obj;
}</p>
<p>#************************************************************</p>
<p>
</p>
<h2><a name="xml_to_object">xml_to_object</a></h2>
<dl>
<dt><strong><a name="xml_to_object" class="item"><code>xml_to_object(@xml_strings_to_convert_to_objects)</code></a></strong></dt>

</dl>
<p>Convert XML strings back into objects.</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>Copyright 2009-2012, Andrew Pitonyak (<a href="mailto:perlboy@pitonyak.org">perlboy@pitonyak.org</a>)</p>
<p>I Andrew Pitonyak wrote this code for my own use and I own it.
That said, you may do as you desire with this code. Use it,
change it, whatever, just don't claim that it is your own.</p>
<p>Also, what ever you do with the code is your own problem.
Although many of my libraries are in production use, I make
no claims to usability, suitability, or reliability.</p>
<p>Although you may do as you desire with the code, I do
appreciate knowing what was done with my code and
interesting changes made by you may be incorporated into
my own copies if you provide them to me.</p>
<p>
</p>
<hr />
<h1><a name="modification_history">Modification History</a></h1>
<p>
</p>
<h2><a name="september_10__2002">September 10, 2002</a></h2>
<p>Version 1.00 Initial release</p>
<p>
</p>
<h2><a name="july_13__2009">July 13, 2009</a></h2>
<p>Version 1.01 Fixed conversion from XML back to an array.</p>

</body>

</html>
